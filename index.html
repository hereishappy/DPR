<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPR & Manpower Logger v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }
        .locked-employee {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-md mx-auto space-y-6">
        
        <!-- PIN Login Screen -->
        <div id="loginScreen" class="bg-white rounded-xl p-6 card-shadow">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">üîê DPR & Manpower Logger</h1>
                <p class="text-gray-600 text-sm">Version 12.0 - Fresh Start</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Supervisor PIN</label>
                    <input type="password" id="supervisorPIN" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter PIN (e.g., MAHE13)">
                </div>
                
                <button onclick="validatePIN()" class="w-full btn-primary text-white py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                    üîì Login
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            
            <!-- Header -->
            <div class="text-center py-4 bg-white rounded-xl card-shadow mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">DPR & Manpower Logger</h1>
                <p class="text-gray-600 text-sm">Welcome, <span id="currentSupervisor" class="font-semibold"></span></p>
                <button onclick="logout()" class="mt-2 text-xs text-red-600 hover:text-red-800">üö™ Logout</button>
            </div>

            <!-- Step 1: Attendance Entry -->
            <div class="bg-white rounded-xl p-6 card-shadow" id="attendanceCard">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-green-100 text-green-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">1</span>
                    Daily Attendance Entry
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="workDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                        <input type="text" id="employeeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Enter employee name">
                    </div>
                    
                    <button onclick="addEmployee()" class="w-full btn-success text-white py-3 rounded-lg font-medium">
                        ‚ûï Add Employee
                    </button>
                    
                    <div id="employeeList" class="space-y-2" style="display: none;">
                        <h4 class="font-medium text-gray-700 border-t pt-3">Today's Attendance:</h4>
                        <div id="employeeEntries"></div>
                    </div>
                    
                    <button onclick="lockAttendance()" id="lockAttendanceBtn" class="w-full btn-primary text-white py-3 rounded-lg font-medium" style="display: none;">
                        üîí Lock Attendance & Proceed to DPR
                    </button>
                </div>
            </div>

            <!-- Step 2: DPR Entry -->
            <div class="bg-white rounded-xl p-6 card-shadow" id="dprCard" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">2</span>
                    DPR Work Entry
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Work Type</label>
                        <select id="workType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Work Type</option>
                            <option value="ERECTION">ERECTION</option>
                            <option value="DISMANTLING">DISMANTLING</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Length (m)</label>
                            <input type="number" id="length" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Width (m)</label>
                            <input type="number" id="width" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Height (m)</label>
                            <input type="number" id="height" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                            <input type="number" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <button onclick="addDPREntry()" class="w-full btn-primary text-white py-3 rounded-lg font-medium">
                        ‚ûï Add DPR Entry
                    </button>
                    
                    <div id="dprList" class="space-y-2" style="display: none;">
                        <h4 class="font-medium text-gray-700 border-t pt-3">Today's DPR Entries:</h4>
                        <div id="dprEntries"></div>
                    </div>
                    
                    <button onclick="completeDPR()" id="completeDPRBtn" class="w-full btn-success text-white py-3 rounded-lg font-medium" style="display: none;">
                        ‚úÖ Complete DPR & Proceed to Overtime
                    </button>
                </div>
            </div>

            <!-- Step 3: Overtime Management -->
            <div class="bg-white rounded-xl p-6 card-shadow" id="overtimeCard" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3">3</span>
                    Overtime Management
                </h2>
                
                <div class="space-y-3">
                    <div id="overtimeEmployeesList" class="space-y-2"></div>
                    
                    <button onclick="finalSubmission()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-3 rounded-lg font-medium">
                        üéØ Submit Final Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supervisor database
        const supervisors = {
            'MAHE13': 'MAHENDRA KUMAR',
            'PINT13': 'PINTU SAH',
            'HARK13': 'HARKIRAT SINGH',
            'SUNI13': 'SUNIL CHAUHAN'
        };

        // Global variables
        let currentSupervisor = '';
        let workDate = '';
        let employees = [];
        let dprEntries = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workDate').value = today;
            workDate = today;
        });

        // PIN Validation
        function validatePIN() {
            const pin = document.getElementById('supervisorPIN').value.toUpperCase().trim();
            
            if (supervisors[pin]) {
                currentSupervisor = supervisors[pin];
                document.getElementById('currentSupervisor').textContent = currentSupervisor;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                showNotification('‚úÖ Login successful!', 'success');
            } else {
                showNotification('‚ùå Invalid PIN. Please try again.', 'error');
                document.getElementById('supervisorPIN').value = '';
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                location.reload();
            }
        }

        // Add Employee
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            
            if (!name) {
                alert('Please enter employee name');
                return;
            }
            
            if (employees.find(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                alert('Employee already added');
                return;
            }
            
            employees.push({
                name: name,
                overtime: 0,
                totalHours: 8
            });
            
            document.getElementById('employeeName').value = '';
            updateEmployeeList();
            showNotification(`‚úÖ ${name} added`, 'success');
        }

        // Update Employee List
        function updateEmployeeList() {
            const container = document.getElementById('employeeEntries');
            container.innerHTML = '';
            
            employees.forEach((emp, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-green-50 p-2 rounded';
                div.innerHTML = `
                    <span class="text-sm font-medium">${index + 1}. ${emp.name}</span>
                    <button onclick="removeEmployee(${index})" class="text-red-600 hover:text-red-800 text-xs">‚ùå</button>
                `;
                container.appendChild(div);
            });
            
            if (employees.length > 0) {
                document.getElementById('employeeList').style.display = 'block';
                document.getElementById('lockAttendanceBtn').style.display = 'block';
            } else {
                document.getElementById('employeeList').style.display = 'none';
                document.getElementById('lockAttendanceBtn').style.display = 'none';
            }
        }

        // Remove Employee
        function removeEmployee(index) {
            if (confirm(`Remove ${employees[index].name}?`)) {
                employees.splice(index, 1);
                updateEmployeeList();
            }
        }

        // Lock Attendance
        function lockAttendance() {
            if (employees.length === 0) {
                alert('Please add at least one employee');
                return;
            }
            
            workDate = document.getElementById('workDate').value;
            
            if (!workDate) {
                alert('Please select work date');
                return;
            }
            
            document.getElementById('attendanceCard').style.display = 'none';
            document.getElementById('dprCard').style.display = 'block';
            showNotification('üîí Attendance locked! Now add DPR entries.', 'success');
        }

        // Add DPR Entry
        function addDPREntry() {
            const workType = document.getElementById('workType').value;
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 0;

            if (!workType || length <= 0 || width <= 0 || height <= 0 || quantity <= 0) {
                alert('Please fill all fields with valid positive numbers');
                return;
            }

            const baseVolume = length * width * height * quantity;
            const actualVolume = workType === 'DISMANTLING' ? baseVolume / 2 : baseVolume;

            dprEntries.push({
                workType,
                length,
                width,
                height,
                quantity,
                volume: actualVolume
            });

            // Clear form
            document.getElementById('workType').value = '';
            document.getElementById('length').value = '';
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
            document.getElementById('quantity').value = '';

            updateDPRList();
            showNotification(`‚úÖ ${workType}: ${actualVolume.toFixed(2)} m¬≥ added`, 'success');
        }

        // Update DPR List
        function updateDPRList() {
            const container = document.getElementById('dprEntries');
            container.innerHTML = '';
            
            dprEntries.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'text-sm bg-blue-50 p-2 rounded';
                div.innerHTML = `
                    <strong>${entry.workType}</strong> - ${entry.volume.toFixed(2)} m¬≥<br>
                    <span class="text-gray-600">${entry.length}√ó${entry.width}√ó${entry.height} √ó ${entry.quantity}</span>
                `;
                container.appendChild(div);
            });
            
            if (dprEntries.length > 0) {
                document.getElementById('dprList').style.display = 'block';
                document.getElementById('completeDPRBtn').style.display = 'block';
            }
        }

        // Complete DPR
        function completeDPR() {
            if (dprEntries.length === 0) {
                alert('Please add at least one DPR entry');
                return;
            }
            
            document.getElementById('dprCard').style.display = 'none';
            document.getElementById('overtimeCard').style.display = 'block';
            updateOvertimeList();
            showNotification('‚úÖ DPR completed! Now manage overtime.', 'success');
        }

        // Update Overtime List
        function updateOvertimeList() {
            const container = document.getElementById('overtimeEmployeesList');
            container.innerHTML = '';
            
            employees.forEach((emp, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center locked-employee p-3 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${index + 1}. ${emp.name}</span><br>
                        <span class="text-xs opacity-80">OT: ${emp.overtime}hrs | Total: ${emp.totalHours}hrs</span>
                    </div>
                    <button onclick="setOvertime(${index})" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium">
                        ‚è∞ Set OT
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Set Overtime
        function setOvertime(index) {
            const currentOT = employees[index].overtime;
            const newOT = prompt(`Set overtime hours for ${employees[index].name}:`, currentOT);
            
            if (newOT !== null && !isNaN(newOT) && newOT >= 0) {
                employees[index].overtime = parseFloat(newOT);
                employees[index].totalHours = 8 + parseFloat(newOT);
                updateOvertimeList();
                showNotification(`‚è∞ Overtime set for ${employees[index].name}`, 'success');
            }
        }

        // Final Submission
        function finalSubmission() {
            if (!currentSupervisor || !workDate || employees.length === 0 || dprEntries.length === 0) {
                alert('Missing required data. Please complete all steps.');
                return;
            }

            // Send to Google Sheets
            sendToGoogleSheets();
            
            // Generate WhatsApp report
            generateWhatsAppReport();
            
            showNotification('üéØ Final submission completed!', 'success');
        }

        // Send to Google Sheets
        function sendToGoogleSheets() {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqVOZwNIu9aCDgt3uP_DrYCowLS6gnvtOeKYHQGhLgUk0tC8LPbXdYLEaEGOv7m0zs/exec';
            
            console.log('=== SENDING TO GOOGLE SHEETS ===');
            console.log('Supervisor:', currentSupervisor);
            console.log('Date:', workDate);
            console.log('Employees:', employees);
            console.log('DPR Entries:', dprEntries);

            // Send DPR data
            dprEntries.forEach((entry, index) => {
                const erectionVol = entry.workType === 'ERECTION' ? entry.volume : 0;
                const dismantlingVol = entry.workType === 'DISMANTLING' ? entry.volume : 0;
                
                const formData = new FormData();
                formData.append('action', 'DPR');
                formData.append('date', workDate);
                formData.append('supervisor', currentSupervisor);
                formData.append('workType', entry.workType);
                formData.append('length', entry.length.toString());
                formData.append('width', entry.width.toString());
                formData.append('height', entry.height.toString());
                formData.append('quantity', entry.quantity.toString());
                formData.append('volume', entry.volume.toString());
                formData.append('erection', erectionVol.toString());
                formData.append('dismantling', dismantlingVol.toString());

                setTimeout(() => {
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    }).then(() => {
                        console.log(`‚úÖ DPR Entry ${index + 1} sent`);
                    }).catch(error => {
                        console.error(`‚ùå DPR Entry ${index + 1} failed:`, error);
                    });
                }, index * 1000);
            });

            // Send Manpower data
            employees.forEach((emp, index) => {
                const formData = new FormData();
                formData.append('action', 'MANPOWER');
                formData.append('date', workDate);
                formData.append('supervisor', currentSupervisor);
                formData.append('employee', emp.name);
                formData.append('overtime', emp.overtime.toString());
                formData.append('totalHours', emp.totalHours.toString());

                setTimeout(() => {
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    }).then(() => {
                        console.log(`‚úÖ Manpower Entry ${index + 1} sent`);
                    }).catch(error => {
                        console.error(`‚ùå Manpower Entry ${index + 1} failed:`, error);
                    });
                }, (dprEntries.length + index) * 1000);
            });
        }

        // Generate WhatsApp Report
        function generateWhatsAppReport() {
            const totalVolume = dprEntries.reduce((sum, entry) => sum + entry.volume, 0);
            const totalManhours = employees.reduce((sum, emp) => sum + emp.totalHours, 0);
            const productivity = totalManhours > 0 ? (totalVolume / totalManhours) : 0;

            const report = `üìä DAILY REPORT

üìÖ Date: ${workDate}
üë®‚Äçüíº Supervisor: ${currentSupervisor}

üë• MANPOWER (${employees.length} employees):
${employees.map((emp, i) => `${i+1}. ${emp.name} - ${emp.totalHours}hrs (OT: ${emp.overtime})`).join('\n')}

üì¶ DPR SUMMARY:
${dprEntries.map(entry => `${entry.workType}: ${entry.volume.toFixed(2)} m¬≥`).join('\n')}

üìä TOTALS:
Total Volume: ${totalVolume.toFixed(2)} m¬≥
Total Manhours: ${totalManhours} hrs
Productivity: ${productivity.toFixed(2)} m¬≥/hr

${productivity < 2.5 ? '‚ö†Ô∏è Performance needs improvement' : '‚úÖ Excellent performance'}

Generated by DPR Logger v12`;

            // Open WhatsApp
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(report)}`;
            window.open(whatsappURL, '_blank');
            
            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                showNotification('üì± Report opened in WhatsApp & copied to clipboard!', 'success');
            });
        }

        // Notification helper
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('supervisorPIN') === document.activeElement) {
                    validatePIN();
                } else if (document.getElementById('employeeName') === document.activeElement) {
                    addEmployee();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965ad539b5bf84d1',t:'MTc1MzYwNTYzNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
